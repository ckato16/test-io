<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Drum and Bass Sequencer</title>
<style>
  body { background:#111; color:#eee; font-family:sans-serif; padding:10px; }
  button { cursor:pointer; }

  h2,h3,h4 { margin:4px 0; }
  hr { border-color:#444; margin:10px 0; }

  /* Global Controls */
  #controls { margin-bottom:20px; }
  .global-controls { display:flex; gap:20px; align-items:flex-end; margin-bottom:10px; }

  /* Sliders */
  .slider-container { display:flex; flex-direction:column; margin-bottom:10px; width:100px; }
  .slider-container label { margin-bottom:3px; }
  .slider-container input[type=range] { width:100%; }
  .slider-container button { margin-top:3px; width:50px; }

  /* Sequencer Grids */
  .seq-grid { display:grid; grid-template-columns:repeat(16,40px); gap:6px; margin-bottom:10px; }
  .step-container { text-align:center; font-size:11px; }
  .step, .dstep { background:#222; border:1px solid #555; width:40px; height:35px;
    display:flex; align-items:center; justify-content:center; cursor:pointer; }
  .step.active { background:#0f0; color:#000; }
  .dstep.active { background:#f50; color:#000; }
  .step.playing, .dstep.playing { outline:2px solid yellow; }
  .pbtn { font-size:9px; padding:0 2px; margin:1px; }

  /* Drum & Bass Controls Wrapper */
  .control-panel { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px; }
  
  /* Spectrum */
  #spectrum { background:#000; display:block; }
  #specWrapper { position:relative; width:800px; margin-top:20px; }
  .axis-label { font-size:10px; color:#eee; position:absolute; }
</style>
</head>
<body>

<h2>Drum and Bass Sequencer</h2>

<!-- -------------------- GLOBAL CONTROLS -------------------- -->
<div id="controls">
  <h3>Global Controls</h3>
  <div class="global-controls">
    <div>
      <label for="bpm">BPM</label><br>
      <input type="number" id="bpm" min="60" max="200" value="120" style="width:60px; text-align:center;">
    </div>
    <button id="play">Play / Stop</button>
  </div>
</div>

<hr>

<!-- -------------------- DRUM SECTION -------------------- -->
<h3>Drum Section</h3>

<div>
  Kick <input type="file" id="kickFile"><br>
  Snare <input type="file" id="snareFile"><br>
  Hi-Hat <input type="file" id="hihatFile">
</div>
<br>

<!-- Drum Sequence -->
<div id="drumSeq" class="seq-grid"></div>

<!-- Drum Controls -->
<div class="control-panel" id="drumControls">
  <div class="slider-container">
    <label>Kick</label>
    <input type="range" id="kickVol" min="0" max="1" step="0.01" value="0.5">
    <button onclick="kickVol.value=0.5;">Reset</button>
    <div id="kickVal">0.5</div>
  </div>
  <div class="slider-container">
    <label>Snare</label>
    <input type="range" id="snareVol" min="0" max="1" step="0.01" value="0.5">
    <button onclick="snareVol.value=0.5;">Reset</button>
    <div id="snareVal">0.5</div>
  </div>
  <div class="slider-container">
    <label>Hi-Hat</label>
    <input type="range" id="hihatVol" min="0" max="1" step="0.01" value="0.5">
    <button onclick="hihatVol.value=0.5;">Reset</button>
    <div id="hihatVal">0.5</div>
  </div>
</div>

<hr>

<!-- -------------------- BASS SECTION -------------------- -->
<h3>Bass Section</h3>

<div class="slider-container">
  <label>Waveform</label>
  <select id="bassWave">
    <option value="sine">Sine</option>
    <option value="square">Square</option>
    <option value="sawtooth" selected>Saw</option>
    <option value="triangle">Triangle</option>
  </select>
</div>

<!-- Bass Sequence -->
<div id="seq" class="seq-grid"></div>

<!-- Bass Controls -->
<div class="control-panel" id="bassControls">
  <div class="slider-container">
    <label>Bass Volume</label>
    <input type="range" id="bassVol" min="0" max="1" step="0.01" value="0.5">
    <button onclick="bassVol.value=0.5;">Reset</button>
    <div id="bassVolVal">0.5</div>
  </div>
  <div class="slider-container">
    <label>Pitch Shift</label>
    <input type="range" id="pitchShift" min="-12" max="12" step="1" value="0">
    <button onclick="pitchShift.value=0;">Reset</button>
    <div id="pitchVal">0</div>
  </div>
  <div class="slider-container">
    <label>LP Cutoff</label>
    <input type="range" id="lpCutoff" min="200" max="8000" value="5000">
    <button onclick="lpCutoff.value=5000; lp.frequency.value=5000;">Reset</button>
    <div id="lpVal">5000</div>
  </div>
  <div class="slider-container">
    <label>Resonance</label>
    <input type="range" id="resonance" min="0" max="25" value="5">
    <button onclick="resonance.value=5; lp.Q.value=5;">Reset</button>
    <div id="resVal">5</div>
  </div>
  <div class="slider-container">
    <label>Env Mod</label>
    <input type="range" id="envMod" min="0" max="1" step="0.01" value="0.5">
    <button onclick="envMod.value=0.5;">Reset</button>
    <div id="envVal">0.5</div>
  </div>
  <div class="slider-container">
    <label>Decay</label>
    <input type="range" id="decay" min="0.05" max="1" step="0.01" value="0.3">
    <button onclick="decay.value=0.3;">Reset</button>
    <div id="decayVal">0.3</div>
  </div>
  <div class="slider-container">
    <label>Overdrive</label>
    <input type="range" id="overdrive" min="0" max="1" step="0.01" value="0">
    <button onclick="resetOverdrive()">Reset</button>
    <div id="odVal">0</div>
  </div>
  <div class="slider-container">
    <label>Delay Time</label>
    <input type="range" id="delayTime" min="0" max="1" step="0.01" value="0.0">
    <button onclick="resetDelayTime()">Reset</button>
    <div id="dTimeVal">0.0</div>
  </div>
  <div class="slider-container">
    <label>Delay FB</label>
    <input type="range" id="delayFB" min="0" max="0.95" step="0.01" value="0.0">
    <button onclick="resetDelayFB()">Reset</button>
    <div id="dFbVal">0.0</div>
  </div>
</div>

<!-- -------------------- SPECTRUM -------------------- -->
<div id="specWrapper">
  <canvas id="spectrum" width="800" height="200"></canvas>
  <div style="position:absolute; left:-30px; top:0; bottom:0; display:flex; flex-direction:column; justify-content:space-between; font-size:10px; color:#eee;">
    <div>1</div>
    <div>0.5</div>
    <div>0</div>
  </div>
  <div style="position:absolute; bottom:-15px; left:0; width:100%; display:flex; justify-content:space-between; font-size:10px; color:#eee;">
    <div>0Hz</div>
    <div>4kHz</div>
    <div>8kHz</div>
  </div>
</div>

<script>
/* AUDIO CONTEXT SETUP */
const ctx = new AudioContext();
let lp = ctx.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=5000;
let amp = ctx.createGain(); amp.gain.value=0;
let analyser = ctx.createAnalyser(); analyser.fftSize=2048;
amp.connect(analyser); analyser.connect(ctx.destination);
let overdrive = ctx.createWaveShaper(); overdrive.curve=makeOD(0); overdrive.oversample="4x";
let delay = ctx.createDelay(); delay.delayTime.value=0.0;
let dFb = ctx.createGain(); dFb.gain.value=0.0;
delay.connect(dFb); dFb.connect(delay); lp.connect(amp); amp.connect(delay); delay.connect(ctx.destination);

function makeOD(a){
  let k=a*100,n=44100,c=new Float32Array(n);
  for(let i=0;i<n;i++){ let x=i/n*2-1; c[i]=((3+k)*x*20*Math.PI/180)/(Math.PI+k*Math.abs(x)); }
  return c;
}

/* UI Elements */
function I(x){ return document.getElementById(x); }
const bpm = I("bpm"), playBtn=I("play");
const pitchShift=I("pitchShift"), lpCutoff=I("lpCutoff"), resonance=I("resonance");
const envMod=I("envMod"), decay=I("decay"), overdriveSlider=I("overdrive");
const delayTime=I("delayTime"), delayFB=I("delayFB");
const kickVol=I("kickVol"), snareVol=I("snareVol"), hihatVol=I("hihatVol");
const bassVol = I("bassVol"), bassWave = I("bassWave");

/* Display updates */
pitchShift.oninput=()=>I("pitchVal").textContent=pitchShift.value;
lpCutoff.oninput=()=>{ lp.frequency.value=lpCutoff.value; I("lpVal").textContent=lpCutoff.value; };
resonance.oninput=()=>{ lp.Q.value=resonance.value; I("resVal").textContent=resonance.value; };
envMod.oninput=()=>I("envVal").textContent=envMod.value;
decay.oninput=()=>I("decayVal").textContent=decay.value;
overdriveSlider.oninput=()=>{ overdrive.curve=makeOD(overdriveSlider.value); I("odVal").textContent=overdriveSlider.value; };
delayTime.oninput=()=>{ delay.delayTime.value=delayTime.value; I("dTimeVal").textContent=delayTime.value; };
delayFB.oninput=()=>{ dFb.gain.value=delayFB.value; I("dFbVal").textContent=delayFB.value; };
kickVol.oninput=()=>I("kickVal").textContent=kickVol.value;
snareVol.oninput=()=>I("snareVal").textContent=snareVol.value;
hihatVol.oninput=()=>I("hihatVal").textContent=hihatVol.value;
bassVol.oninput=()=>I("bassVolVal").textContent=bassVol.value;
bassWave.onchange=()=>{ if(osc) osc.type=bassWave.value; };

function resetOverdrive(){ overdriveSlider.value=0; overdrive.curve=makeOD(0); I("odVal").textContent="0"; }
function resetDelayTime(){ delayTime.value=0.2; delay.delayTime.value=0.0; I("dTimeVal").textContent="0.0"; }
function resetDelayFB(){ delayFB.value=0.3; dFb.gain.value=0.0; I("dFbVal").textContent="0.0"; }

/* ------------------ SEQUENCERS ------------------ */
/* Bass */
let sequence=[]; const baseNote=48;
for(let i=0;i<16;i++) sequence.push({note:baseNote, active:false, accent:false, slide:false});
const seqDiv=I("seq");
function renderSeq(play=-1){
  seqDiv.innerHTML="";
  sequence.forEach((s,i)=>{
    let box=document.createElement("div"); box.className="step-container";
    let btn=document.createElement("div"); btn.className="step"+(s.active?" active":"");
    if(i===play) btn.classList.add("playing"); btn.textContent=midiName(s.note);
    btn.onclick=()=>{ s.active=!s.active; renderSeq(play); };
    let up=document.createElement("button"); up.className="pbtn"; up.textContent="↑"; up.onclick=e=>{e.stopPropagation(); s.note++; renderSeq(play);};
    let dn=document.createElement("button"); dn.className="pbtn"; dn.textContent="↓"; dn.onclick=e=>{e.stopPropagation(); s.note--; renderSeq(play);};
    let a=document.createElement("button"); a.className="pbtn"; a.textContent="A"; a.style.color=s.accent?"yellow":"#888"; a.onclick=e=>{e.stopPropagation(); s.accent=!s.accent; renderSeq(play);};
    let sl=document.createElement("button"); sl.className="pbtn"; sl.textContent="S"; sl.style.color=s.slide?"cyan":"#888"; sl.onclick=e=>{e.stopPropagation(); s.slide=!s.slide; renderSeq(play);};
    box.appendChild(btn); box.appendChild(up); box.appendChild(dn); box.appendChild(a); box.appendChild(sl);
    seqDiv.appendChild(box);
  });
}
function midiName(n){ const names=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]; return names[n%12]+Math.floor(n/12); }
renderSeq();

/* Drum */
let drumSeq={kick:[], snare:[], hihat:[]};
["kick","snare","hihat"].forEach(d=>{ for(let i=0;i<16;i++) drumSeq[d].push(false); });
const drumDiv=I("drumSeq");
function renderDrum(play=-1){
  drumDiv.innerHTML="";
  ["kick","snare","hihat"].forEach(d=>{
    drumSeq[d].forEach((st,i)=>{
      let b=document.createElement("div"); b.className="dstep step"+(st?" active":"");
      if(i===play) b.classList.add("playing"); b.textContent=d[0].toUpperCase();
      b.onclick=()=>{ drumSeq[d][i]=!drumSeq[d][i]; renderDrum(play); };
      drumDiv.appendChild(b);
    });
  });
}
renderDrum();

/* Drum Sample Upload */
let drumBuffers={kick:null, snare:null, hihat:null};
function loadDrum(elem,type){
  if(!elem.files.length) return;
  let r=new FileReader();
  r.onload=async e=>{ drumBuffers[type]=await ctx.decodeAudioData(e.target.result); };
  r.readAsArrayBuffer(elem.files[0]);
}
I("kickFile").onchange=()=>loadDrum(I("kickFile"),"kick");
I("snareFile").onchange=()=>loadDrum(I("snareFile"),"snare");
I("hihatFile").onchange=()=>loadDrum(I("hihatFile"),"hihat");

/* ------------------ PLAYBACK ------------------ */
let osc=null, step=0, timer=null, prevFreq=null;
function midiFreq(n){ return 440*Math.pow(2,(n-69)/12); }

function playStep(s){
  let now=ctx.currentTime;
  if(!s.active){ amp.gain.setValueAtTime(0.0001,now); return; }
  let f=midiFreq(s.note+parseInt(pitchShift.value));
  if(s.slide && prevFreq){ osc.frequency.setValueAtTime(prevFreq,now); osc.frequency.linearRampToValueAtTime(f,now+0.12); } else { osc.frequency.setValueAtTime(f,now); }
  prevFreq=f;
  let accent = s.accent?1.4:1.0;
  let vol = accent * parseFloat(bassVol.value);
  let baseLP = parseFloat(lpCutoff.value);
  let envAmt = parseFloat(envMod.value);
  let peakLP = baseLP + envAmt*5000;
  lp.frequency.cancelScheduledValues(now); lp.frequency.setValueAtTime(baseLP,now); lp.frequency.linearRampToValueAtTime(peakLP,now+0.05); lp.frequency.exponentialRampToValueAtTime(baseLP,now+parseFloat(decay.value));
  amp.gain.cancelScheduledValues(now); amp.gain.setValueAtTime(0.0001,now); amp.gain.linearRampToValueAtTime(vol,now+0.01); amp.gain.exponentialRampToValueAtTime(0.0001,now+parseFloat(decay.value));
}

function trigDrum(type){
  let vol=parseFloat({kick:kickVol.value,snare:snareVol.value,hihat:hihatVol.value}[type]);
  if(drumBuffers[type]){
    let s=ctx.createBufferSource(); s.buffer=drumBuffers[type]; let g=ctx.createGain(); g.gain.value=vol; s.connect(g); g.connect(ctx.destination); s.start(); return;
  }
}

playBtn.onclick=()=>{
  if(timer){ clearInterval(timer); timer=null; playBtn.textContent="Play"; step=0; renderSeq(); renderDrum(); return; }
  if(!osc){ osc=ctx.createOscillator(); osc.type=bassWave.value; osc.connect(lp); lp.connect(overdrive); overdrive.connect(amp); amp.connect(delay); delay.connect(ctx.destination); osc.start(); }
  timer=setInterval(()=>{
    playStep(sequence[step]);
    ["kick","snare","hihat"].forEach(d=>{ if(drumSeq[d][step]) trigDrum(d); });
    renderSeq(step); renderDrum(step);
    step=(step+1)%16;
  }, 60000/bpm.value/4); // 16th notes
  playBtn.textContent="Stop";
};

/* ------------------ SPECTRUM ------------------ */
const canvas = I("spectrum"); const ctx2d = canvas.getContext("2d");
const bufferLength = analyser.frequencyBinCount; const dataArray = new Uint8Array(bufferLength);

function drawSpectrum(){
  requestAnimationFrame(drawSpectrum);
  analyser.getByteFrequencyData(dataArray);
  ctx2d.fillStyle="#000"; ctx2d.fillRect(0,0,canvas.width,canvas.height);
  const width=canvas.width, height=canvas.height;
  for(let i=0;i<bufferLength;i++){
    let val=dataArray[i]; let barHeight=val/255*height;
    let x;
    x=i/bufferLength*width;
    ctx2d.fillStyle="lime"; ctx2d.fillRect(x, height-barHeight, width/bufferLength, barHeight);
  }
}
drawSpectrum();
</script>
</body>
</html>
